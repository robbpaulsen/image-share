# Story 1.5: Photo Processing and Storage

## Status
Done

## Story

**As a** system operator,
**I want** uploaded photos to be automatically processed, renamed, and moved to the display directory,
**so that** photos are organized and ready for display without manual intervention.

## Acceptance Criteria

1. Background process monitors `raw_images/` directory every 10 seconds for new files.
2. Each new image file is processed by renaming it to a UUID v4 filename (e.g., `a3f2b8c1-9d4e-4f6a-8c2b-1e3d5f7a9b0c.jpg`), preserving the original file extension.
3. The processed (renamed) image is moved to the `display_images/` directory.
4. The original file in `raw_images/` is deleted after successful processing.
5. If processing fails (e.g., due to a corrupted image file), the file is moved to the `failed_images/` directory and an error is logged.
6. The processing logic handles up to 5 concurrent uploads queued without data loss or corruption.
7. The `display_images/` directory preserves chronological order via file modification timestamps.
8. Logging captures the original filename to UUID mapping, processing timestamp, and any errors encountered.
9. Unit tests cover UUID generation uniqueness, file move operations, and error handling for corrupted files.

## Tasks / Subtasks

- [x] **Task 1: Create Photo Processor Module**
  - [x] Create file `apps/api/core/processor.py`.
  - [x] Import required libraries: `uuid`, `pathlib`, `logging`, `asyncio`, `shutil`.
  - [x] Define logic to encapsulate processing.
  - [x] Set up Python logging for the module.

- [x] **Task 2: Implement Directory Monitoring Loop**
  - [x] Create `async def monitor_raw_images()` as a background task.
  - [x] Use `asyncio.sleep(10)` to poll `raw_images/` every 10 seconds.
  - [x] Use `pathlib.Path.glob()` to find new image files.
  - [x] Implement a tracking mechanism to prevent duplicate processing.
  - [x] Handle up to 5 concurrent processing tasks.

- [x] **Task 3: Implement UUID Renaming**
  - [x] Create a function to generate a UUID v4 filename, preserving the original extension.
  - [x] Use `uuid.uuid4()` for the unique identifier.
  - [x] Log the original filename to UUID mapping.

- [x] **Task 4: Implement Image Processing Pipeline**
  - [x] Create an async function `process_single_image(image_path: Path)`.
  - [x] Call the UUID generation function.
  - [x] **Try block:** Move the file from `raw_images/` to `display_images/` with the new UUID name. Use `shutil.move` or similar.
  - [x] Log successful processing.
  - [x] **Except block:** Catch exceptions (e.g., file not found, permissions error).
  - [x] On error, move the file to `failed_images/`.
  - [x] Log any errors encountered.

- [x] **Task 5: Integrate Processor with FastAPI Startup**
  - [x] Modify `apps/api/main.py` to import and run the processor.
  - [x] Use `asyncio.create_task()` to start the `monitor_raw_images()` loop within the FastAPI lifespan context.
  - [x] Log processor startup and shutdown events.

- [x] **Task 6: Implement Comprehensive Logging**
  - [x] Log each monitoring cycle.
  - [x] Log the start of each file processing.
  - [x] Log the UUID mapping.
  - [x] Log successful completion and processing duration.
  - [x] Log errors with filename and error details.
  - [x] Log file moves to `failed_images/`.

- [x] **Task 7: Write Unit Tests**
  - [x] Create test file `apps/api/tests/test_processor.py`.
  - [x] Test UUID generation uniqueness and format.
  - [x] Test file move from `raw_images/` to `display_images/`.
  - [x] Test error handling for file operations.
  - [x] Test that a failed file is moved to `failed_images/`.
  - [x] Test that logging captures the required information.

- [x] **Task 8: Manual and Concurrency Testing**
  - [x] Manually place files in `raw_images/` and verify they are processed and moved to `display_images/`.
  - [x] Test with 5+ simultaneous uploads to ensure no data loss or race conditions.
  - [x] Verify the processing queue handles the backlog correctly.

## Dev Notes

### Scope of Processing
As per the project's defined scope, image processing is limited to **renaming and moving files**. No image manipulation (like EXIF correction, resizing, or watermarking) is performed. The processor's sole job is to take a file from `raw_images/`, give it a unique UUID-based name, and move it to `display_images/`.

### Core Workflow
The processor is a background task that bridges the upload and display systems.
`Upload API` -> `raw_images/` -> **`Photo Processor`** -> `display_images/` -> `Carousel UI`

### Technology Stack
- **Language:** Python 3.10+
- **Background Processing:** `asyncio` (Python standard library)
- **File Operations:** `pathlib`, `shutil`

### Asyncio Background Task
The processor is integrated into the FastAPI application's lifecycle using the `lifespan` context manager. An `asyncio.create_task()` call starts the monitoring loop when the application starts, and the task is gracefully cancelled on shutdown.

### Error Handling
- If any error occurs during the file move/rename operation (e.g., permission errors), the processor will attempt to move the problematic file to the `failed_images/` directory.
- This ensures that one bad file does not stop the entire processing pipeline.

### Testing
- Unit tests in `apps/api/tests/test_processor.py` validate the core logic of renaming, moving, and error handling using temporary directories provided by `pytest`.
- Manual testing is required to confirm the end-to-end flow in a running application.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-15 | 2.0 | Re-scoped to remove EXIF processing and align with project documentation. | Gemini |

## QA Results

### Review Date: 2025-10-15

### Reviewed By: Gemini

### Assessment
This story has been significantly simplified to align with the project's core requirements. The focus is now solely on the file-handling pipeline.

- **Code Quality:** The conceptual design is straightforward, using standard Python libraries for file monitoring and operations.
- **Compliance:** The story now correctly reflects the "in-scope" and "out-of-scope" items defined in `important_conversations_withLlm/TODO.md`.
- **Requirements Traceability:** All acceptance criteria are directly related to monitoring, renaming, moving, and logging files, with no mention of image content analysis.
- **Testing:** The testing strategy is simplified, focusing on file system operations and logging, which is appropriate for the new scope.

### Gate Status: PASS
The story is now correctly aligned with the project's documented scope. All references to out-of-scope EXIF processing have been removed.
